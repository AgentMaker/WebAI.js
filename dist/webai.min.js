(()=>{var e={511:e=>{const t={getIMScale:function(e,t,s,r,i){let o,l;if(r){let r=Math.min(e,t),n=Math.min(s[0],s[1])/r;if(i){let r=Math.max(e,t),i=Math.max(s[0],s[1]);Math.round(n*r)>i&&(n=i/r)}o=n,l=n}else l=s[0]/e,o=s[1]/t;return[o,l]},rgba2rgb:function(e){let t=new cv.Mat;return cv.cvtColor(e,t,cv.COLOR_RGBA2RGB),t},resize:function(e,t,s,r,i,o,l){let[n,a]=this.getIMScale(t,s,r,i,o),c=new cv.Mat;return cv.resize(e,c,{width:0,height:0},n,a,l),[c,n,a]},crop:function(e,t){let s=e.roi({x:Math.ceil((e.cols-t[1])/2),y:Math.ceil((e.rows-t[0])/2),width:t[1],height:t[0]});return e.delete(),s},normalize:function(e,t,s,r,i){if(e.convertTo(e,cv.CV_32F),i){let s=new cv.Mat(e.rows,e.cols,cv.CV_32FC3,t);cv.divide(e,s,e),s.delete()}let o=new cv.Mat(e.rows,e.cols,cv.CV_32FC3,s);cv.subtract(e,o,e),o.delete();let l=new cv.Mat(e.rows,e.cols,cv.CV_32FC3,r);return cv.divide(e,l,e),l.delete(),e},permute:function(e){let t=new cv.MatVector;cv.split(e,t);let s=t.get(0),r=t.get(1),i=t.get(2);t.delete();let o=new Float32Array(3*s.data32F.length);return o.set(s.data32F,0),o.set(r.data32F,s.data32F.length),o.set(i.data32F,2*s.data32F.length),s.delete(),r.delete(),i.delete(),e.delete(),o},loadText:function(e){let t=new XMLHttpRequest;return t.open("get",e,!1),t.send(null),t.responseText},getColorMap:function(e){let t=e.length,s=[],r=Math.ceil(16777216/t);for(let i=0;i<t;i++){let t=(r*i).toString(16),o=[];for(let e=0;e<6;e+=2){let s=t.slice(e,e+2);""==s?o.push(0):o.push(parseInt("0x"+s))}o.push(255),s.push({label:e[i],color:o})}return s},argMax:function(e){let t=Math.max.apply(null,e);return e.findIndex((function(e,s,r){return e==t}))},Model:class{static async create(e,t,s={logSeverityLevel:4}){let r=new this;return r.loadConfigs(t),r.session=await ort.InferenceSession.create(e,s),r}loadConfigs(e){let s=JSON.parse(t.loadText(e)),r=s.Preprocess;this.isPermute=!1,this.isCrop=!1,this.isResize=!1;for(let e=0;e<r.length;e++){let t=r[e];if("Resize"==t.type)this.isResize=!0,this.interp=t.interp,this.keepRatio=t.keep_ratio,this.targetSize=t.target_size;else if("Normalize"==t.type)this.isScale=t.is_scale,this.limitMax=t.limit_max,this.isScale&&(this.scale=[255,255,255,0]),this.mean=t.mean,this.mean.push(0),this.std=t.std,this.std.push(0);else if("Crop"==t.type)this.isCrop=!0,this.cropSize=t.crop_size;else{if("Permute"!=t.type)throw`Not support ${t.type} OP.`;this.isPermute=!0}}s.hasOwnProperty("label_list")?(this.labelList=s.label_list,this.colorMap=t.getColorMap(this.labelList)):this.labelList=null}preProcess(e,s,r){let i,o,l,n;if(this.isResize?[i,o,l]=t.resize(e,s,r,this.targetSize,this.keepRatio,this.limitMax,this.interp):i=e.clone(),this.isCrop){let e=t.crop(i,this.cropSize);n=t.rgba2rgb(e),e.delete()}else n=t.rgba2rgb(i),i.delete();let a,c=t.normalize(n,this.scale,this.mean,this.std,this.isScale),[h,p]=[c.rows,c.cols];return this.isPermute?a=new ort.Tensor("float32",t.permute(c),[1,3,h,p]):(a=new ort.Tensor("float32",c.data32F,[1,h,p,3]),c.delete()),this.getFeeds(a,o,l)}async infer(e,...t){console.time("Infer"),console.time("Infer.Preprocess");let[s,r]=[e.rows,e.cols],i=this.preProcess(e,s,r);console.timeEnd("Infer.Preprocess"),console.time("Infer.Run");let o=await this.session.run(i);console.timeEnd("Infer.Run"),console.time("Infer.Postprocess");let l=this.postProcess(o,...t);return console.timeEnd("Infer.Postprocess"),console.timeEnd("Infer"),l}}};t.Det=class extends t.Model{getFeeds(e,t,s){let r=this.session.inputNames,i={im_shape:new ort.Tensor("float32",Float32Array.from(e.dims.slice(2,4)),[1,2]),image:e,scale_factor:new ort.Tensor("float32",Float32Array.from([s,t]),[1,2])},o={};for(let e=0;e<r.length;e++)o[r[e]]=i[r[e]];return o}postProcess(e,...t){let[s,r,i]=t,o=Object.values(e)[0],l=[],n=o.dims[0],a=o.data;for(let e=0;e<n;e++){let t=a[6*e+0],o=a[6*e+1],n=Math.max(0,Math.round(a[6*e+2])),c=Math.max(0,Math.round(a[6*e+3])),h=Math.min(r,Math.round(a[6*e+4])),p=Math.min(s,Math.round(a[6*e+5])),u=this.labelList[t],d=this.colorMap[t].color;if(o>i){let e={label:u,color:d,score:o,x1:n,y1:c,x2:h,y2:p};l.push(e)}}return l}async infer(e,t=.5){return super.infer(e,e.rows,e.cols,t)}},t.Cls=class extends t.Model{getFeeds(e,t,s){return{x:e}}postProcess(e,...t){let s=t[0],r=Object.values(e)[0].data,i=[];for(let e=0;e<this.labelList.length;e++)i.push({label:this.labelList[e],prob:r[e]});return i.sort(((e,t)=>t.prob-e.prob)).slice(0,s)}async infer(e,t=5){return super.infer(e,t)}},t.Seg=class extends t.Model{getFeeds(e,t,s){return{x:e}}postProcess(e){let s=Object.values(e)[0],r=s.data,[i,o,l,n]=s.dims,a=l*n,c=[];for(let e=0;e<o;e++)c.push(r.slice(e*a,(e+1)*a));let h,p,u=[],d=[];for(let e=0;e<a;e++){h=[];for(let t=0;t<o;t++)h.push(c[t][e]);p=t.argMax(h),d.push(p),u.push(...this.colorMap[p].color)}return{argMax:d,colorMapping:u,colorMap:this.colorMap}}infer(e){return super.infer(e)}},e.exports=t}},t={};function s(r){var i=t[r];if(void 0!==i)return i.exports;var o=t[r]={exports:{}};return e[r](o,o.exports,s),o.exports}(()=>{function e(e){let t=document.createElement("script");t.setAttribute("type","text/javascript"),t.setAttribute("src",e),document.getElementsByTagName("head")[0].appendChild(t)}e("https://docs.opencv.org/4.5.5/opencv.js"),e("https://cdn.jsdelivr.net/npm/onnxruntime-web@1.10.0/dist/ort.wasm.min.js");const t=s(511);window.WebAI=t})()})();